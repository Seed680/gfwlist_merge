name: Update Rules

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC æ—¶é—´ 22:00 (åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 06:00)
  schedule:
    - cron: '0 22 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:
  
  # ä»£ç å˜åŠ¨è§¦å‘ï¼šå½“ release.py æˆ–ç›¸å…³æ–‡ä»¶ä¿®æ”¹æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'release.py'
      - '.github/workflows/update_rules.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout codebase
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. è¿è¡Œæ‚¨çš„è„šæœ¬
      - name: Run release script
        run: |
          echo "ğŸ“‚å½“å‰ç›®å½•ï¼š"
          pwd
          echo "ğŸ“‚ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -R
          echo "--------------------------------"
          python release.py
          echo "âœ… è§„åˆ™ç”Ÿæˆå®Œæ¯•ï¼Œå‡†å¤‡å‘å¸ƒ..."
          ls -R gfwlist2_python_output  # æ‰“å°ç›®å½•ç»“æ„ä»¥ä¾›è°ƒè¯•
      - name: Commit file
        run: |
            curl -s "https://raw.githubusercontent.com/Seed680/Toolkit/main/Git.sh" > "/tmp/Git.sh"
            sudo bash "/tmp/Git.sh" -u "Seed680" -e "noone@gmail.com" -f "./gfwlist2_python_output/*" -r "GFWList" -i "Generated by GitHub Actions" -m "push"
      # 4. å°†ç”Ÿæˆçš„æ–‡ä»¶æ¨é€åˆ° release åˆ†æ”¯
      # ä½¿ç”¨ peaceiris/actions-gh-pages æ˜¯å‘å¸ƒé™æ€æ–‡ä»¶æœ€ç®€å•çš„æ–¹æ³•
      # å®ƒä¼šå°† gfwlist2_python_output æ–‡ä»¶å¤¹é‡Œçš„å†…å®¹å¼ºåˆ¶æ¨é€åˆ° release åˆ†æ”¯çš„æ ¹ç›®å½•
      - name: Deploy to release branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gfwlist2_python_output  # æŒ‡å®šè¦å‘å¸ƒçš„æ–‡ä»¶å¤¹
          publish_branch: release                # å‘å¸ƒåˆ°å“ªä¸ªåˆ†æ”¯
          force_orphan: true                     # å¼ºåˆ¶è¦†ç›–æ¨¡å¼ (è®© release åˆ†æ”¯ä¿æŒåªæœ‰æœ€æ–°çš„ä¸€æ¬¡æäº¤ï¼Œä¸äº§ç”Ÿå†å²åƒåœ¾)
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Auto-update rules [skip ci]'
