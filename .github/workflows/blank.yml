name: Update Rules

on:
  # 定时触发：每天 UTC 时间 22:00 (北京时间次日 06:00)
  schedule:
    - cron: '0 22 * * *'
  
  # 手动触发：允许在 Actions 页面手动点击运行
  workflow_dispatch:
  
  # 代码变动触发：当 release.py 或相关文件修改时自动运行
  push:
    paths:
      - 'release.py'
      - '.github/workflows/update_rules.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout codebase
        uses: actions/checkout@v4

      # 2. 设置 Python 环境
      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. 运行您的脚本
      - name: Run release script
        run: |
          python release.py
          echo "✅ 规则生成完毕，准备发布..."
          ls -R gfwlist2_python_output  # 打印目录结构以供调试
      - name: Commit file
        run: |
            curl -s "https://raw.githubusercontent.com/Seed680/Toolkit/main/Git.sh" > "/tmp/Git.sh"
            sudo bash "/tmp/Git.sh" -u "Seed680" -e "noone@gmail.com" -f "./gfwlist2_python_output/*" -r "GFWList" -i "Generated by GitHub Actions" -m "push"
      # 4. 将生成的文件推送到 release 分支
      # 使用 peaceiris/actions-gh-pages 是发布静态文件最简单的方法
      # 它会将 gfwlist2_python_output 文件夹里的内容强制推送到 release 分支的根目录
      - name: Deploy to release branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gfwlist2_python_output  # 指定要发布的文件夹
          publish_branch: release                # 发布到哪个分支
          force_orphan: true                     # 强制覆盖模式 (让 release 分支保持只有最新的一次提交，不产生历史垃圾)
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Auto-update rules [skip ci]'
